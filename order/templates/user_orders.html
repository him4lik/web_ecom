{% extends 'base.html' %}

{% block title %}
   <title>Your Orders</title>
{% endblock %}

{% block categories %}
{% endblock %}

{% block orders %}
<div class="container mt-4 mb-5">
    <div class="row">
        <div class="col-lg-12">
            <!-- Orders Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-shopping-bag me-2 text-primary"></i> Recent Orders
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                    <th>Order Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in orders %}
                                <tr>
                                    <td>{{ order.receipt_id }}</td>
                                    <td>{{ order.created_at }}</td>
                                    <td>{{ order.total_quantity }} Items</td>
                                    <td>₹{{ order.cost }}</td>
                                    <td><span class="badge bg-success">{{ order.status }}</span></td>
                                    <td>
                                        {% if order.is_paid %}
                                            <button class="btn btn-success" disabled>Paid</button>
                                        {% else %}
                                            <form action="{% url 'payment' %}" method="post">
                                                {% csrf_token %}
                                                <input type="hidden" name="order_id" value="{{ order.order_id }}">
                                                <button type="submit" class="btn btn-primary">Pay Now</button>
                                            </form>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#orderDetails-{{ order.receipt_id }}" 
                                                aria-expanded="false" aria-controls="#orderDetails-{{ order.receipt_id }}">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </td>
                                </tr>

                                <!-- Order Details Collapse -->
                                <tr class="collapse" id="orderDetails-{{ order.receipt_id }}">
                                    <td colspan="6">
                                        <div class="p-3 bg-light rounded">
                                            <h6 class="mb-3">Order Details</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p><strong>Products:</strong></p>
                                                    <ul class="list-group">
                                                        {% for product in order.sold_products %}
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            <a href="{% url 'detail' product.slug %}" class="text-decoration-none">
                                                                <img src="{{ product.file_path }}" class="rounded" width="60" height="60">
                                                            </a>
                                                            <span class="badge bg-primary rounded-pill">Qty: {{ product.quantity }}</span>
                                                            <span class="mb-1">Price: {{ product.individual_cost }}</span>
                                                            <span class="mb-1">Total: {{ product.total_cost }}</span>
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                                <div class="col-md-6">
                                                    <p><strong>Shipping Address:</strong></p>
                                                    <p class="mb-1">{{ order.address.address_type }} - {{ order.address.poc_name }}</p>
                                                    <p class="mb-1">{{ order.address.line_1 }}, {{ order.address.line_2 }}</p>
                                                    <p class="mb-1">{{ order.address.city }}, {{ order.address.state }} {{ order.address.pin }}</p>
                                                    <p class="mb-1">Phone: {{ order.address.phone }}</p>
                                                    <p class="mb-1">Landmark: {{ order.address.landmark }}</p>
                                                </div>
                                            </div>

                                            <div class="mt-3">
                                                <p><strong>Order Summary:</strong></p>
                                                <div class="d-flex justify-content-between">
                                                    <span>Subtotal:</span>
                                                    <span>₹{{ order.cost }}</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>Shipping:</span>
                                                    <span>₹{{ order.shipping }}</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>Tax:</span>
                                                    <span>₹{{ order.gst }}</span>
                                                </div>
                                                <hr>
                                                <div class="d-flex justify-content-between fw-bold">
                                                    <span>Total:</span>
                                                    <span>₹{{ order.total_cost }}</span>
                                                </div>

                                                <div class="mt-3 text-end">
                                                    {% if order.is_paid %}
                                                        <button class="btn btn-success" disabled>Paid</button>
                                                    {% else %}
                                                        <form action="{% url 'payment' %}" method="post">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="order_id" value="{{ order.order_id }}">
                                                            <button type="submit" class="btn btn-primary">Pay Now</button>
                                                        </form>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div></div>
                        <div>
                            <nav>
                                <ul class="pagination mb-0">
                                    {% if offset > 0 %}
                                    <li class="page-item">
                                        <a class="page-link" href="?offset={{ prev_offset }}&limit={{ limit }}">Previous</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                                    {% endif %}

                                    {% if has_more %}
                                    <li class="page-item">
                                        <a class="page-link" href="?offset={{ offset|add:limit }}&limit={{ limit }}">Next</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Razorpay Payment Form -->
<form action="{% url 'razorpay-callback' %}" method="POST" id="payment-form">
    {% csrf_token %}
    <input type="hidden" name="razorpay_payment_id" id="razorpay_payment_id">
    <input type="hidden" name="razorpay_order_id" id="razorpay_order_id">
    <input type="hidden" name="razorpay_signature" id="razorpay_signature">
</form>

<button id="rzp-button1"
    style="display:none;"
    data-key="{{ KEY_ID }}"
    data-currency="INR"
    data-name="{{ company.name }}"
    data-description="Test Transaction"
    data-order-id="{{ order_id }}"
    data-dismiss-url="{% url 'user-orders' %}"
    data-prefill-name="{{ order_details.name }}"
    data-prefill-email="{{ order_details.email }}"
    data-prefill-contact="{{ order_details.phone }}"
    data-auto-open="{% if open_razorpay %}true{% else %}false{% endif %}">
    Pay with Razorpay
</button>



{% endblock %}
